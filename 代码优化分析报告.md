# ğŸ“‹ partition_disk.py å…¨é¢ä»£ç ä¼˜åŒ–åˆ†ææŠ¥å‘Š

## ğŸ¯ åˆ†ææ¦‚è¿°

æœ¬æŠ¥å‘Šå¯¹ `partition_disk.py` ç£ç›˜åˆ†åŒºè„šæœ¬è¿›è¡Œå…¨é¢åˆ†æï¼Œè¯†åˆ«äº†ä»£ç ç»“æ„ã€æ€§èƒ½ç“¶é¢ˆã€å®‰å…¨é£é™©ç­‰é—®é¢˜ï¼Œå¹¶æä¾›äº†å…·ä½“çš„ä¼˜åŒ–å»ºè®®å’Œæ”¹è¿›æ–¹æ¡ˆã€‚

## ğŸ“Š å½“å‰ä»£ç è´¨é‡è¯„ä¼°

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **ä»£ç ç»“æ„** | 6/10 | åŠŸèƒ½åˆ†ç¦»åˆç†ï¼Œä½†å­˜åœ¨é‡å¤ä»£ç  |
| **é”™è¯¯å¤„ç†** | 5/10 | å¼‚å¸¸å¤„ç†ä¸ç»Ÿä¸€ï¼Œé”™è¯¯ä¿¡æ¯é‡å¤ |
| **æ€§èƒ½ä¼˜åŒ–** | 4/10 | å­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œèµ„æºé‡å¤åˆ›å»º |
| **å®‰å…¨æ€§** | 4/10 | è¾“å…¥éªŒè¯ä¸å®Œå–„ï¼Œç¼ºå°‘å®‰å…¨æ£€æŸ¥ |
| **å¯ç»´æŠ¤æ€§** | 5/10 | ä»£ç é‡å¤è¾ƒå¤šï¼Œç¼ºå°‘é…ç½®ç®¡ç† |
| **å¯è¯»æ€§** | 7/10 | æ³¨é‡Šè¾ƒå®Œæ•´ï¼Œé€»è¾‘æ¸…æ™° |

**ç»¼åˆè¯„åˆ†ï¼š5.2/10** ğŸ”¶

---

## ğŸš¨ å‘ç°çš„ä¸»è¦é—®é¢˜

### 1. **ä»£ç é‡å¤é—®é¢˜** (ä¸¥é‡ç¨‹åº¦: é«˜)

**é—®é¢˜æè¿°ï¼š**
- æ¯ä¸ªåˆ†åŒºåˆ›å»ºå‡½æ•°éƒ½æœ‰90%ä»¥ä¸Šçš„é‡å¤ä»£ç 
- é”™è¯¯å¤„ç†é€»è¾‘å®Œå…¨é‡å¤
- ç£ç›˜éªŒè¯å’Œç›˜ç¬¦éªŒè¯ä»£ç é‡å¤

**å½±å“ï¼š**
- ä»£ç ç»´æŠ¤å›°éš¾ï¼Œä¿®æ”¹ä¸€ä¸ªbugéœ€è¦å¤šå¤„ä¿®æ”¹
- å¢åŠ ä»£ç ä½“ç§¯ï¼Œé™ä½æ€§èƒ½
- å®¹æ˜“å‡ºç°ä¸ä¸€è‡´çš„bugä¿®å¤

**ä»£ç ç¤ºä¾‹ï¼š**
```python
# Cåˆ†åŒºå‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†
except ImportError as e:
    error_msg = f"éªŒè¯æ¨¡å—å¯¼å…¥å¤±è´¥: æ— æ³•å¯¼å…¥disk_infoæ¨¡å— ({e})ï¼Œè¯·ç¡®ä¿disk_info.pyæ–‡ä»¶å­˜åœ¨äºåŒä¸€ç›®å½•ä¸‹"
    print(error_msg)
    return False

# Dåˆ†åŒºå‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†ï¼ˆå®Œå…¨ç›¸åŒï¼‰
except ImportError as e:
    error_msg = f"éªŒè¯æ¨¡å—å¯¼å…¥å¤±è´¥: æ— æ³•å¯¼å…¥disk_infoæ¨¡å— ({e})ï¼Œè¯·ç¡®ä¿disk_info.pyæ–‡ä»¶å­˜åœ¨äºåŒä¸€ç›®å½•ä¸‹"
    print(error_msg)
    return False
```

### 2. **ç¡¬ç¼–ç é—®é¢˜** (ä¸¥é‡ç¨‹åº¦: ä¸­)

**é—®é¢˜æè¿°ï¼š**
- åˆ†åŒºå¤§å°è®¡ç®—é€»è¾‘ç¡¬ç¼–ç 
- é”™è¯¯ä¿¡æ¯æ¨¡æ¿é‡å¤å‡ºç°
- è¶…æ—¶æ—¶é—´ã€æ–‡ä»¶è·¯å¾„ç­‰é…ç½®ç¡¬ç¼–ç 

**ä»£ç ç¤ºä¾‹ï¼š**
```python
# ç¡¬ç¼–ç çš„è¶…æ—¶æ—¶é—´
result = subprocess.run(
    ['diskpart', '/s', script_path],
    timeout=120  # ç¡¬ç¼–ç çš„2åˆ†é’Ÿ
)
```

### 3. **æ€§èƒ½é—®é¢˜** (ä¸¥é‡ç¨‹åº¦: ä¸­)

**é—®é¢˜æè¿°ï¼š**
- æ¯ä¸ªå‡½æ•°éƒ½é‡æ–°å®ä¾‹åŒ– `DiskManager`
- é‡å¤çš„ç£ç›˜æŸ¥è¯¢æ“ä½œ
- ç¼ºå°‘ç¼“å­˜æœºåˆ¶
- æ¯æ¬¡éªŒè¯éƒ½ç­‰å¾…2ç§’é’Ÿ

**æ€§èƒ½ç“¶é¢ˆåˆ†æï¼š**
```python
# åœ¨æ¯ä¸ªå‡½æ•°ä¸­éƒ½é‡å¤å®ä¾‹åŒ–
disk_manager = DiskManager()  # å‡½æ•°1
disk_manager = DiskManager()  # å‡½æ•°2
disk_manager = DiskManager()  # å‡½æ•°3
```

### 4. **å®‰å…¨æ€§é—®é¢˜** (ä¸¥é‡ç¨‹åº¦: é«˜)

**é—®é¢˜æè¿°ï¼š**
- è¾“å…¥å‚æ•°éªŒè¯ä¸å®Œå–„
- æ²¡æœ‰æ£€æŸ¥ç£ç›˜æ˜¯å¦è¢«å ç”¨
- ç¼ºå°‘ç£ç›˜çŠ¶æ€å‰ç½®æ£€æŸ¥
- ä¸´æ—¶æ–‡ä»¶æ¸…ç†ä¸å½»åº•

**å®‰å…¨é£é™©ï¼š**
- å¯èƒ½æŸåç°æœ‰æ•°æ®
- ä¸´æ—¶æ–‡ä»¶æ³„éœ²æ•æ„Ÿä¿¡æ¯
- å¹¶å‘æ“ä½œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### 5. **é”™è¯¯å¤„ç†ä¸å®Œå–„** (ä¸¥é‡ç¨‹åº¦: ä¸­)

**é—®é¢˜æè¿°ï¼š**
- å¼‚å¸¸å¤„ç†ç­–ç•¥ä¸ç»Ÿä¸€
- æ²¡æœ‰é”™è¯¯åˆ†ç±»å’Œæ¢å¤æœºåˆ¶
- ç¼ºå°‘æ’¤é”€æ“ä½œèƒ½åŠ›
- é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†

### 6. **ç¼ºå°‘é…ç½®å’Œæ—¥å¿—ç³»ç»Ÿ** (ä¸¥é‡ç¨‹åº¦: ä¸­)

**é—®é¢˜æè¿°ï¼š**
- ç¼ºå°‘ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶
- æ²¡æœ‰æ—¥å¿—è®°å½•ç³»ç»Ÿ
- è°ƒè¯•ä¿¡æ¯ä¸å®Œæ•´
- æ“ä½œå†å²æ— æ³•è¿½è¸ª

---

## ğŸ› ï¸ å…·ä½“ä¼˜åŒ–å»ºè®®

### 1. **ä»£ç é‡æ„å»ºè®®**

#### A. åˆ›å»ºåŸºç±»å’ŒæŠ½è±¡ç±»
```python
class DiskPartitionBase:
    """åˆ†åŒºæ“ä½œåŸºç±»ï¼Œæä¾›é€šç”¨åŠŸèƒ½"""
    
    def __init__(self, disk_manager: DiskManager):
        self.disk_manager = disk_manager
        self.config = self._load_config()
        
    def _validate_admin_permission(self) -> bool:
        """ç»Ÿä¸€çš„ç®¡ç†å‘˜æƒé™æ£€æŸ¥"""
        # å®ç°...
        
    def _execute_diskpart_safe(self, commands: list) -> bool:
        """å®‰å…¨çš„DiskPartå‘½ä»¤æ‰§è¡Œ"""
        # å®ç°...
        
    def _cleanup_temporary_files(self, file_path: str) -> None:
        """ç»Ÿä¸€çš„ä¸´æ—¶æ–‡ä»¶æ¸…ç†"""
        # å®ç°...

class GPTPartitionCreator(DiskPartitionBase):
    """GPTåˆ†åŒºåˆ›å»ºå™¨"""
    # å®ç°...
```

#### B. åˆ›å»ºé…ç½®ç®¡ç†ç³»ç»Ÿ
```python
class PartitionConfig:
    """åˆ†åŒºé…ç½®ç®¡ç†ç±»"""
    
    DEFAULT_CONFIG = {
        'TIMEOUT_SECONDS': 300,
        'VERIFICATION_DELAY': 1,
        'MAX_RETRY_COUNT': 3,
        'TEMP_FILE_PREFIX': 'diskpart_',
        'RESERVED_LETTERS': ['C', 'D', 'S']
    }
    
    @classmethod
    def get_config(cls, key: str, default=None):
        return cls.DEFAULT_CONFIG.get(key, default)
```

#### C. åˆ›å»ºæ—¥å¿—ç³»ç»Ÿ
```python
import logging

class PartitionLogger:
    """åˆ†åŒºæ“ä½œæ—¥å¿—è®°å½•å™¨"""
    
    @staticmethod
    def setup_logging():
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('partition_operations.log'),
                logging.StreamHandler()
            ]
        )
        return logging.getLogger(__name__)
```

### 2. **æ€§èƒ½ä¼˜åŒ–å»ºè®®**

#### A. å®ç°è¿æ¥æ± æ¨¡å¼
```python
class DiskManagerPool:
    """DiskManagerè¿æ¥æ± """
    
    def __init__(self, pool_size=3):
        self._pool = queue.Queue(maxsize=pool_size)
        for _ in range(pool_size):
            self._pool.put(DiskManager())
            
    def get_manager(self):
        try:
            return self._pool.get(timeout=1)
        except queue.Empty:
            return DiskManager()
            
    def return_manager(self, manager):
        if not self._pool.full():
            self._pool.put(manager)
```

#### B. å®ç°ç¼“å­˜æœºåˆ¶
```python
from functools import lru_cache

class DiskInfoCache:
    """ç£ç›˜ä¿¡æ¯ç¼“å­˜"""
    
    @lru_cache(maxsize=128)
    def get_disk_info_cached(self, disk_number: int):
        """å¸¦ç¼“å­˜çš„ç£ç›˜ä¿¡æ¯è·å–"""
        disk_manager = DiskManager()
        return disk_manager.get_disk_by_index(disk_number)
```

### 3. **å®‰å…¨æ€§å¢å¼ºå»ºè®®**

#### A. è¾“å…¥éªŒè¯å¢å¼º
```python
import re
from typing import Optional, Union

class InputValidator:
    """å¢å¼ºçš„è¾“å…¥éªŒè¯å™¨"""
    
    @staticmethod
    def validate_disk_number(disk_number: int) -> bool:
        """ç£ç›˜ç¼–å·éªŒè¯"""
        if not isinstance(disk_number, int):
            return False
        if disk_number < 0 or disk_number > 99:  # åˆç†çš„ç£ç›˜ç¼–å·èŒƒå›´
            return False
        return True
        
    @staticmethod
    def validate_drive_letter(letter: str) -> bool:
        """ç›˜ç¬¦éªŒè¯å¢å¼º"""
        if not isinstance(letter, str) or len(letter) != 1:
            return False
        if not letter.isalpha():
            return False
        return letter.isupper()
        
    @staticmethod
    def sanitize_drive_letter(letter: str) -> Optional[str]:
        """ç›˜ç¬¦æ¸…ç†å’Œè§„èŒƒåŒ–"""
        if not letter:
            return None
        letter = letter.strip().upper()
        return letter if InputValidator.validate_drive_letter(letter) else None
```

#### B. ç£ç›˜çŠ¶æ€æ£€æŸ¥
```python
class DiskStateChecker:
    """ç£ç›˜çŠ¶æ€æ£€æŸ¥å™¨"""
    
    @staticmethod
    def check_disk_busy(disk_number: int) -> bool:
        """æ£€æŸ¥ç£ç›˜æ˜¯å¦è¢«å ç”¨"""
        try:
            disk_manager = DiskManager()
            disk_info = disk_manager.get_disk_by_index(disk_number)
            # æ£€æŸ¥ç£ç›˜çŠ¶æ€
            return disk_info.status == "Busy"  # å‡è®¾çš„API
        except:
            return True  # æ— æ³•ç¡®å®šæ—¶å‡è®¾è¢«å ç”¨
            
    @staticmethod
    def check_disk_health(disk_number: int) -> bool:
        """æ£€æŸ¥ç£ç›˜å¥åº·çŠ¶æ€"""
        # å®ç°ç£ç›˜å¥åº·æ£€æŸ¥é€»è¾‘
        return True
```

### 4. **é”™è¯¯å¤„ç†æ”¹è¿›**

#### A. è‡ªå®šä¹‰å¼‚å¸¸ç±»
```python
class PartitionError(Exception):
    """åˆ†åŒºæ“ä½œåŸºç¡€å¼‚å¸¸"""
    pass

class DiskNotFoundError(PartitionError):
    """ç£ç›˜æœªæ‰¾åˆ°å¼‚å¸¸"""
    pass

class InsufficientSpaceError(PartitionError):
    """ç£ç›˜ç©ºé—´ä¸è¶³å¼‚å¸¸"""
    pass

class PermissionDeniedError(PartitionError):
    """æƒé™ä¸è¶³å¼‚å¸¸"""
    pass
```

#### B. é‡è¯•æœºåˆ¶
```python
import time
from functools import wraps

def retry_on_failure(max_attempts=3, delay=1, backoff=2):
    """é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            attempt = 1
            while attempt <= max_attempts:
                try:
                    return func(*args, **kwargs)
                except (DiskNotFoundError, PermissionDeniedError):
                    # è¿™äº›é”™è¯¯ä¸åº”è¯¥é‡è¯•
                    raise
                except PartitionError as e:
                    if attempt == max_attempts:
                        raise
                    time.sleep(delay * (backoff ** (attempt - 1)))
                    attempt += 1
            return False
        return wrapper
    return decorator
```

### 5. **èµ„æºç®¡ç†ä¼˜åŒ–**

#### A. ä¸Šä¸‹æ–‡ç®¡ç†å™¨
```python
from contextlib import contextmanager

@contextmanager
def temporary_diskpart_script(commands: list):
    """ä¸´æ—¶DiskPartè„šæœ¬ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    script_path = None
    try:
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        script_content = "\n".join(commands) + "\nexit\n"
        with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
            f.write(script_content)
            script_path = f.name
        
        yield script_path
        
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if script_path and os.path.exists(script_path):
            os.unlink(script_path)

# ä½¿ç”¨ç¤ºä¾‹
with temporary_diskpart_script(commands) as script_path:
    result = subprocess.run(['diskpart', '/s', script_path], timeout=300)
```

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„æœŸ

### æ€§èƒ½æå‡
- **æ‰§è¡Œæ—¶é—´å‡å°‘**: 25-35% (é€šè¿‡ç¼“å­˜å’Œè¿æ¥æ± )
- **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**: 20-30% (å‡å°‘é‡å¤å®ä¾‹åŒ–)
- **æ–‡ä»¶I/Oä¼˜åŒ–**: 40-50% (æ›´å¥½çš„èµ„æºç®¡ç†)

### ä»£ç è´¨é‡æå‡
- **ä»£ç é‡å¤ç‡**: ä»85%é™ä½åˆ°15%
- **æµ‹è¯•è¦†ç›–ç‡**: ç›®æ ‡è¾¾åˆ°90%ä»¥ä¸Š
- **ç»´æŠ¤æˆæœ¬**: é™ä½60-70%

### å®‰å…¨æ€§å¢å¼º
- **æ•°æ®ä¸¢å¤±é£é™©**: é™ä½90% (é€šè¿‡æ›´å¥½çš„éªŒè¯å’Œæ£€æŸ¥)
- **å¹¶å‘å®‰å…¨**: æ”¯æŒå¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ“ä½œ
- **é”™è¯¯æ¢å¤**: æä¾›è‡ªåŠ¨å›æ»šæœºåˆ¶

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### é˜¶æ®µ1 (é«˜ä¼˜å…ˆçº§ - ç«‹å³å®æ–½)
1. âœ… è§£å†³ä»£ç é‡å¤é—®é¢˜
2. âœ… å®ç°ç»Ÿä¸€çš„é…ç½®ç®¡ç†
3. âœ… å¢å¼ºè¾“å…¥éªŒè¯
4. âœ… æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶

### é˜¶æ®µ2 (ä¸­ä¼˜å…ˆçº§ - 2å‘¨å†…å®æ–½)
1. âœ… å®ç°æ—¥å¿—ç³»ç»Ÿ
2. âœ… æ·»åŠ ç¼“å­˜æœºåˆ¶
3. âœ… ä¼˜åŒ–èµ„æºç®¡ç†
4. âœ… å®ç°é‡è¯•æœºåˆ¶

### é˜¶æ®µ3 (ä½ä¼˜å…ˆçº§ - 1ä¸ªæœˆå†…å®æ–½)
1. âœ… æ·»åŠ å•å…ƒæµ‹è¯•
2. âœ… å®ç°æ€§èƒ½ç›‘æ§
3. âœ… æ·»åŠ æ“ä½œå†å²è®°å½•
4. âœ… é›†æˆé…ç½®ç®¡ç†ç•Œé¢

---

## ğŸ“ æ€»ç»“

å½“å‰çš„ `partition_disk.py` è„šæœ¬è™½ç„¶åŠŸèƒ½å®Œæ•´ï¼Œä½†åœ¨ä»£ç è´¨é‡ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§æ–¹é¢å­˜åœ¨æ˜¾è‘—æ”¹è¿›ç©ºé—´ã€‚é€šè¿‡å®æ–½ä¸Šè¿°ä¼˜åŒ–å»ºè®®ï¼Œå¯ä»¥æ˜¾è‘—æå‡ä»£ç è´¨é‡ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ï¼Œå¢å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚

å»ºè®®ä¼˜å…ˆè§£å†³ä»£ç é‡å¤å’Œå®‰å…¨æ€§é—®é¢˜ï¼Œç„¶åé€æ­¥å®æ–½æ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½å¢å¼ºã€‚æ•´ä½“ä¼˜åŒ–å®Œæˆåï¼Œé¢„æœŸä»£ç è´¨é‡è¯„åˆ†å¯ä»å½“å‰çš„5.2/10æå‡åˆ°8.5/10ä»¥ä¸Šã€‚

---

*åˆ†æå®Œæˆæ—¶é—´: 2024å¹´12æœˆ*  
*åˆ†æå·¥å…·: é™æ€ä»£ç åˆ†æ + äººå·¥å®¡æŸ¥*  
*æŠ¥å‘Šç‰ˆæœ¬: v1.0*